<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>GeneVariantMacros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1438730976000</creationDate>
  <parent>PhenoTips.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1439237364000</date>
  <contentUpdateDate>1439230895000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{include reference="PhenoTips.TabelarDataMacros" /}}&#xd;
&#xd;
{{velocity output=false}}&#xd;
## =====================================================================&#xd;
##&#xd;
## Genes and variants entered in the patient report&#xd;
##&#xd;
##&#xd;
#macro (__variant_row $variantObj $count $variantIndex $options)&#xd;
|(% class="pseudoindent" %) |(% class="variant-row-count variant" %) $count #foreach($propName in $options.defaultProperties) |(% class="variant variant-default-input variant-$variantIndex" %) $doc.display($propName, $options.mode, $variantObj) #end |(% class="variant moreinfo" %)#if ($options.mode == 'edit')(% class="variant-moreinfo-editbutton-row variant-$variantIndex" %)#end(((&#xd;
#foreach ($prop in $variantObj.xWikiClass.properties)&#xd;
&#xd;
#set ($isDefault = $options.defaultProperties.contains($prop.getName()))&#xd;
#set ($isInputString = $options.inputStrings.contains($prop.getName()))&#xd;
#set($rawValue = $variantObj.getProperty($prop.getName()).value)&#xd;
#if ($prop.getName() != 'genesymbol')|(% class="variant-moreinfo variant-property-name-$variantIndex #if ($rawValue == 'NA' || $rawValue == '')v-collapsed#end" %)**${prop.translatedPrettyName}**|#if($isDefault)(% class="default-$variantIndex" %)#{end} (% class="variant-property-value ${prop.getName()}-$variantIndex #if ($options.mode == 'edit' &amp;&amp; !$isDefault)variant-label-$variantIndex #end #if ($rawValue == 'NA' || $rawValue == '')v-collapsed#end"%)#if($isInputString) $rawValue#else$doc.display($prop.getName(), 'view', $variantObj )#end(%%) #if ($options.mode == 'edit' &amp;&amp; !$isDefault)(% class="v-collapsed variant-input-$variantIndex" %)$doc.display($prop.getName(), $options.mode, $variantObj )#end#end##&#xd;
#end&#xd;
))) #if ($options.mode == 'edit')(% class="variant-moreinfo-editdonebutton-row variant-$variantIndex" %)|(% class="variant" %)#__variant__deleteTool($variantObj 'extradata-PhenoTips.GeneVariantClass')#end\\&#xd;
#end&#xd;
##&#xd;
##&#xd;
##&#xd;
#macro(__variant_head $count $geneNumber $geneName $options)##&#xd;
|(%class="pseudoindent"%) |=(% colSpan="6" class="variant variant-title gene-$geneNumber" %) $services.localization.render('phenotips.geneVariantMacros.variantTable.title', [$geneName, $count])|(% class="pseudoindent" %) \\&#xd;
(%class="variant-title-row variant-hide-heading-$geneNumber"%)|(%class="pseudoindent"%) |=(% class="variant" %)(%%)#foreach($propName in $options.defaultProperties) |=(% class="variant col-label" %) $propName #end |=(% class="variant" %)$services.localization.render('phenotips.geneVariantMacros.variantTable.moreInfo') |=(% class="variant" %)&#xd;
#end&#xd;
##&#xd;
##&#xd;
##&#xd;
#macro(__variant_foot $options $geneNumber)##&#xd;
|(%class="pseudoindent"%) |(% colSpan="6" class="variant variant-footer-$geneNumber" %) #if ($options.mode == 'edit') #__variant_addTool('PhenoTips.GeneVariantClass' '' $options)#end\\&#xd;
#end&#xd;
##&#xd;
##&#xd;
##&#xd;
#macro(__variant_table $variantObjects $geneNumber $geneName $options)##&#xd;
#if ($variantObjects.size() > 0)##&#xd;
(%class="variant-title-row"%)#__variant_head($variantObjects.size(), $geneNumber, $geneName, $options)&#xd;
#foreach ($o in $variantObjects)&#xd;
#set ($variantIndex = $foreach.index + $geneNumber)&#xd;
#set ($variantCount = $foreach.count)&#xd;
(%class="variant-hide-heading-$geneNumber"%)#__variant_row($o "${geneNumber}.${variantCount}" $variantIndex $options)&#xd;
#end&#xd;
#end&#xd;
(%class="variant-footer"%)#__variant_foot($options $geneNumber)&#xd;
#end&#xd;
##&#xd;
##&#xd;
##&#xd;
#macro (__gene__deleteWithVariants__tool $geneObj)&#xd;
  {{html clean="false"}}&lt;a class="action delete-gene" href="$doc.getURL('get', "sheet=PhenoTips.GeneVariantMacros&amp;amp;form_token=$!{services.csrf.getToken()}&amp;amp;action=deletegene&amp;amp;objnumber=$geneObj.number&amp;amp;gene=")" title="$services.localization.render('phenotips.tableMacros.delete')">✖&lt;/a>{{/html}}##&#xd;
#end&#xd;
##&#xd;
##&#xd;
##&#xd;
#macro (__variant__deleteTool $object $anchor)&#xd;
{{html clean="false"}}&lt;a class="action delete-variant" href="$doc.getURL('objectremove', "classname=${object.xWikiClass.name}&amp;amp;amp;classid=${object.number}&amp;amp;amp;form_token=$!{services.csrf.getToken()}#$!{anchor}")" title="$services.localization.render('phenotips.tableMacros.delete')">✖&lt;/a>{{/html}}##&#xd;
#end&#xd;
##&#xd;
##&#xd;
#macro (__variant_addTool $classname $anchor $options)&#xd;
 {{html clean="false"}}&lt;span class="buttonwrapper">&lt;label class="create-button-label">+&lt;/label>&lt;a class="add button add-data-button" href="$doc.getURL('objectadd', "classname=${classname}&amp;amp;amp;#foreach($d in $options.defaults.keySet())&amp;amp;amp;${classname}_${escapetool.url($d)}=$!{escapetool.url($options.defaults.get($d))}#end&amp;amp;amp;form_token=$!{services.csrf.getToken()}#$!{anchor}")" title="$label">$label&lt;/a>&lt;/span&amp;gt;{{/html}} {{icon name="question-circle" cssClass="xHelpButton" title="$services.localization.render("${classname}_hint").replace('"', '~~~"')"/}}&#xd;
#end&#xd;
##&#xd;
#macro (__gene_row $geneObj $geneNumber $variantClass $options)&#xd;
#set($variantObjects = $doc.getObjects($variantClass.name, "genesymbol", $geneObj.getProperty('gene').value))&#xd;
|(% class="row-count" %)$geneNumber #foreach($prop in $geneObj.xWikiClass.properties) |(% class="gene col-label gene-$geneNumber" #if ($foreach.index == 0) colspan="2" #end %) $doc.display($prop.name, $options.mode, $geneObj) #end|#if ($options.mode == 'edit')(% class="gene delete-gene-button-$geneNumber" %)#__gene__deleteWithVariants__tool($geneObj)#end&#xd;
&#xd;
#set ($variantOptions = {})&#xd;
#set ($discard = $variantOptions.putAll($options))&#xd;
#set ($def = $variantOptions.put('defaults', {'genesymbol': $geneObj.getProperty('gene').value}))##&#xd;
#__variant_table($variantObjects $geneNumber $geneObj.getProperty('gene').value $variantOptions)&#xd;
#end&#xd;
##&#xd;
##&#xd;
##&#xd;
#macro (__gene_table $options)&#xd;
#set($geneClass = $xwiki.getDocument('PhenoTips.GeneClass').xWikiClass)&#xd;
#set($variantClass = $xwiki.getDocument('PhenoTips.GeneVariantClass').xWikiClass)&#xd;
=== $services.localization.render('phenotips.UIXField.genes.sheetTitle')===&#xd;
(% id="gene-table" class="gene-table extradata-list" %)&#xd;
|= #foreach($prop in $geneClass.properties) |=(% class="gene"  #if ($foreach.index == 0) colspan="2" #end %) $prop.translatedPrettyName #end |=(% class="gene" %)&#xd;
#set($geneObjects = $doc.getObjects($geneClass.name))&#xd;
#foreach ($o in $geneObjects)&#xd;
#set ($geneNumber = $foreach.count)&#xd;
#__gene_row($o $geneNumber $variantClass $options)&#xd;
#end&#xd;
|(% colSpan="8" class="gene" %) #if ($options.mode == 'edit')#__extradata_addTool('PhenoTips.GeneClass' 'extradata-PhenoTips.GeneClass' {'mode' : 'edit', 'newEntryLabel' : $services.localization.render('phenotips.geneVariantMacros.geneTable.newEntry')})#end&#xd;
#end&#xd;
{{/velocity}}&#xd;
&#xd;
{{velocity}}&#xd;
#if ($xcontext.action == 'get' &amp;&amp; $request.action == 'deletegene' &amp;&amp; "$!{request.gene}" != '' &amp;&amp; "$!{request.objnumber}" != '' &amp;&amp; $services.csrf.isTokenValid("$!{request.form_token}"))&#xd;
  #set ($geneObject = $doc.getObject('PhenoTips.GeneClass', $!{request.objnumber}))&#xd;
  #set ($variantObjects = $doc.getObjects('PhenoTips.GeneVariantClass', 'genesymbol', $request.gene))&#xd;
  ## delete gene&#xd;
  $doc.removeObject($geneObject)&#xd;
  ## delete variants&#xd;
  #foreach ($v in $variantObjects)&#xd;
    $doc.removeObject($v)&#xd;
  #end&#xd;
  ## save document&#xd;
  $doc.save('Deleted gene and variants')&#xd;
#end&#xd;
{{/velocity}}</content>
</xwikidoc>
