<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>GeneVariantMacros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1438730976000</creationDate>
  <parent>PhenoTips.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1439856148000</date>
  <contentUpdateDate>1439855857000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>&#xd;
{{velocity output=false}}&#xd;
## =====================================================================&#xd;
##&#xd;
## Genes and variants entered in the patient report&#xd;
##&#xd;
##&#xd;
## -----------Add/Delete buttons macros-------------------&#xd;
##&#xd;
#macro (__gene_addTool $classname)&#xd;
 {{html clean="false"}}&lt;span class="buttonwrapper" style="position : relative">&lt;label class="create-button-label">+&lt;/label>&lt;a class="button add-gene add-data-button" href="$doc.getURL('objectadd', "classname=${classname}&amp;amp;xpage=plain&amp;amp;xaction=lastentry&amp;amp;withLabel=false&amp;amp;form_token=$!{services.csrf.getToken()}")" title="$services.localization.render("$!{classname}.geneTable.newEntry")">$services.localization.render("$!{classname}.geneTable.newEntry")&lt;/a>&lt;/span>{{/html}} {{icon name="question-circle" cssClass="xHelpButton" title="$services.localization.render("${classname}_hint").replace('"', '~~~"')"/}}&#xd;
#end&#xd;
##&#xd;
#macro (__gene__deleteWithVariants__tool $geneObj $variantClassName)&#xd;
  {{html clean="false"}}&lt;a class="action delete-gene" href="$doc.getURL('get', "geneclassname=${geneObj.xWikiClass.name}&amp;amp;variantclassname=$variantClassName&amp;amp;form_token=$!{services.csrf.getToken()}&amp;amp;action=deletegene&amp;amp;objnumber=$geneObj.number&amp;amp;gene=")" title="$services.localization.render('phenotips.tableMacros.delete')">✖&lt;/a>{{/html}}##&#xd;
#end&#xd;
##&#xd;
##&#xd;
#macro (__variant_addTool $classname $genesymbol)&#xd;
 {{html clean="false"}}&lt;span class="buttonwrapper" style="position : relative">&lt;label class="create-button-label">+&lt;/label>&lt;a class="button add-variant add-data-button" href="$doc.getURL('objectadd', "classname=${classname}&amp;amp;xpage=plain&amp;amp;xaction=lastentry&amp;amp;withLabel=false&amp;amp;${classname}_genesymbol=$genesymbol&amp;amp;form_token=$!{services.csrf.getToken()}")" title="$services.localization.render("${classname}.variantTable.newEntry")"> $services.localization.render("${classname}.variantTable.newEntry")&lt;/a>&lt;/span>{{/html}} {{icon name="question-circle" cssClass="xHelpButton" title="$services.localization.render("${classname}.add.hint").replace('"', '~~~"')"/}}&#xd;
#end&#xd;
##&#xd;
#macro (__variant__deleteTool $object)&#xd;
{{html clean="false"}}&lt;a class="action delete-variant" href="$doc.getURL('objectremove', "classname=${object.xWikiClass.name}&amp;amp;classid=${object.number}&amp;amp;form_token=$!{services.csrf.getToken()}")"  title="$services.localization.render('phenotips.tableMacros.delete')">✖&lt;/a>{{/html}}##&#xd;
#end&#xd;
##&#xd;
##&#xd;
## -----------Variants table macros-------------------&#xd;
##&#xd;
#macro(__variant_head $count $geneObjNumber $geneName $classname $options)##&#xd;
|(%class="pseudoindent"%) |=(% colSpan="6" class="variant variant-title gene-$geneObjNumber" %) $services.localization.render("${classname}.variantTable.title", [$geneName, $count])|(% class="pseudoindent" %) \\&#xd;
(%class="variant-gene-$geneObjNumber variant-title-row variant-hide-heading-$geneObjNumber"%)|(%class="pseudoindent"%) |=(% class="variant" %)(%%)#foreach($propName in $options.defaultProperties) |=(% class="variant col-label" %) $propName #end |=(% class="variant" %)$services.localization.render("${classname}.variantTable.moreInfo") |=(% class="variant" %)&#xd;
#end&#xd;
##&#xd;
##&#xd;
#macro (__variant_row $variantObj $count $variantIndex $options)&#xd;
|(% class="pseudoindent" %) |(% class="variant-row-count variant" %) $count #foreach($propName in $options.defaultProperties) |(% class="variant variant-default-input variant-$variantIndex" %) $doc.display($propName, $options.mode, $variantObj) #end |(% class="variant moreinfo" %)#if ($options.mode == 'edit')(% class="variant-moreinfo-editbutton-row variant-$variantIndex" %)#end(((&#xd;
#foreach ($prop in $variantObj.xWikiClass.properties)&#xd;
&#xd;
#set ($isDefault = $options.defaultProperties.contains($prop.getName()))&#xd;
#set ($isInputString = $options.inputStrings.contains($prop.getName()))&#xd;
#set($rawValue = $variantObj.getProperty($prop.getName()).value)&#xd;
#if ($prop.getName() != 'genesymbol')|(% class="variant-moreinfo variant-property-name-$variantIndex %)**${prop.translatedPrettyName}**|#if($isDefault)(% class="default-$variantIndex" %)#{end} (% class="variant-property-value ${prop.getName()}-$variantIndex #if ($options.mode == 'edit' &amp;&amp; !$isDefault) variant-label-$variantIndex #end%) #if($isInputString) $rawValue #else $doc.display($prop.getName(), 'view', $variantObj )#end (%%) #if ($options.mode == 'edit' &amp;&amp; !$isDefault)(% class="v-collapsed variant-input-$variantIndex" %)$doc.display($prop.getName(), $options.mode, $variantObj )#end#end##&#xd;
#end&#xd;
))) #if ($options.mode == 'edit')(% class="variant-moreinfo-editdonebutton-row variant-$variantIndex" %)|(% class="variant" %)#__variant__deleteTool($variantObj)#end\\&#xd;
#end&#xd;
##&#xd;
##&#xd;
#macro(__variant_table $variantObjects $geneNumber $geneObjNumber $options $genesymbol $variantClassName)##&#xd;
#if ($variantObjects.size() > 0)##&#xd;
(%class="variant-gene-$geneObjNumber variant-title-row"%)#__variant_head($variantObjects.size() $geneObjNumber $genesymbol $variantClassName $options)&#xd;
#foreach ($o in $variantObjects)&#xd;
#set ($variantIndex = $o.number)&#xd;
#set ($variantCount = $foreach.count)&#xd;
(%class="variant-gene-$geneObjNumber variant-hide-heading-$geneObjNumber"%)#__variant_row($o "${geneNumber}.${variantCount}" $variantIndex $options)&#xd;
#end&#xd;
#end&#xd;
(%class="variant-gene-$geneObjNumber variant-footer #if ($genesymbol == "") v-collapsed#end"%)#__variant_foot($options $geneObjNumber $genesymbol $variantClassName)&#xd;
#end&#xd;
##&#xd;
##&#xd;
#macro(__variant_foot $options $geneObjNumber $genesymbol $variantClassName)##&#xd;
|(%class="pseudoindent"%) |(% colSpan="6" class="variant variant-footer-$geneObjNumber" %) #if ($options.mode == 'edit') #__variant_addTool($variantClassName $genesymbol)#end\\&#xd;
#end&#xd;
##&#xd;
## -----------Gene table macros-------------------&#xd;
##&#xd;
#macro (__gene_row $geneObj $geneNumber $variantClass $options)&#xd;
#set($geneObjNumber = $geneObj.number)&#xd;
#set($variantObjects = $doc.getObjects($variantClass.name, "genesymbol", $geneObj.getProperty('gene').value))&#xd;
|(% class="row-count" %)$geneNumber #foreach($prop in $geneObj.xWikiClass.properties) |(% class="gene gene-$geneObjNumber" #if ($foreach.index == 0) colspan="2" #end %) $doc.display($prop.name, $options.mode, $geneObj) #end|#if ($options.mode == 'edit')(% class="gene delete-gene-button-$geneObjNumber" %)#__gene__deleteWithVariants__tool($geneObj $variantClass.name)#end&#xd;
&#xd;
#__variant_table($variantObjects $geneNumber $geneObjNumber $options $geneObj.getProperty('gene').value $variantClass.name)&#xd;
#end&#xd;
##&#xd;
##&#xd;
#macro (__gene_table $geneClassName $variantClassName $options)&#xd;
#set($geneClass = $xwiki.getDocument($geneClassName).xWikiClass)&#xd;
#set($variantClass = $xwiki.getDocument($variantClassName).xWikiClass)&#xd;
=== $services.localization.render('phenotips.UIXField.genes.sheetTitle')===&#xd;
(% id="extradata-list-$geneClassName" class="gene-table extradata-list withCounter" %)&#xd;
|= #foreach($prop in $geneClass.properties) |=(% class="gene col-label"  #if ($foreach.index == 0) colspan="2" #end %) $prop.translatedPrettyName #end |=(% class="gene" %)&#xd;
#set($geneObjects = $doc.getObjects($geneClass.name))&#xd;
#foreach ($o in $geneObjects)&#xd;
#set ($geneNumber = $foreach.count)&#xd;
#__gene_row($o $geneNumber $variantClass $options)&#xd;
#end&#xd;
&#xd;
#if ($options.mode == 'edit')(% class="list-actions" %)(((#__gene_addTool($geneClassName))))#end&#xd;
#end&#xd;
{{/velocity}}&#xd;
&#xd;
{{velocity output=false}}&#xd;
## =====================================================================&#xd;
##&#xd;
## Delete gene script service with bulk variants delete&#xd;
##&#xd;
##&#xd;
#if ($xcontext.action == 'get' &amp;&amp; $request.action == 'deletegene' &amp;&amp; "$!{request.gene}" != '' &amp;&amp; "$!{request.objnumber}" != '' &amp;&amp; $services.csrf.isTokenValid("$!{request.form_token}"))&#xd;
  #set ($geneObject = $doc.getObject($!{request.geneclassname}, $!{request.objnumber}))&#xd;
  #set ($variantObjects = $doc.getObjects($!{request.variantclassname}, 'genesymbol', $request.gene))&#xd;
  ## delete gene&#xd;
  $doc.removeObject($geneObject)&#xd;
  ## delete variants&#xd;
  #foreach ($v in $variantObjects)&#xd;
    $doc.removeObject($v)&#xd;
  #end&#xd;
  ## save document&#xd;
  $doc.save('Deleted gene and variants')&#xd;
#end&#xd;
{{/velocity}}</content>
</xwikidoc>
