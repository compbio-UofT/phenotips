<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>TabelarDataMacros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1401822205000</creationDate>
  <parent>PhenoTips.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1439856152000</date>
  <contentUpdateDate>1439846110000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity output=false}}&#xd;
$xwiki.jsx.use('PhenoTips.TabelarDataMacros')##&#xd;
$xwiki.ssx.use('PhenoTips.TabelarDataMacros')##&#xd;
## =====================================================================&#xd;
##&#xd;
## "Tabelar" data associated with the patient report&#xd;
##&#xd;
##&#xd;
#macro (__extradata_deleteTool $object $anchor)&#xd;
  {{html clean="false"}}&lt;a class="action delete" href="$doc.getURL('objectremove', "classname=${object.xWikiClass.name}&amp;amp;classid=${object.number}&amp;amp;xredirect=$escapetool.url($doc.getURL('edit'))&amp;amp;form_token=$!{services.csrf.getToken()}#$!{anchor}")" title="$services.localization.render('phenotips.tableMacros.delete')">âœ–&lt;/a>{{/html}}##&#xd;
#end&#xd;
&#xd;
#macro (__extradata_addTool $classname $anchor $options)&#xd;
  {{html clean="false"}}&lt;span class="buttonwrapper">&lt;label class="create-button-label">+&lt;/label>&lt;a class="add button add-data-button" href="$doc.getURL('objectadd', "classname=${classname}&amp;amp;${classname}_$!{options.propertyName}=$!escapetool.url($!{options.propertyValue})&amp;amp;xredirect=$escapetool.url(${doc.getURL($options.mode)})&amp;amp;propertyName=$!{options.propertyName}&amp;amp;propertyValue=$!escapetool.url($!{options.propertyValue})#foreach($d in $options.defaults.keySet())&amp;amp;${classname}_${escapetool.url($d)}=$!{escapetool.url($options.defaults.get($d))}#end&amp;amp;addedDisplaySheet=$!escapetool.url($!{options.addedDisplaySheet})&amp;amp;form_token=$!{services.csrf.getToken()}#$!{anchor}")" title="$services.localization.render('phenotips.tableMacros.newEntry')">$services.localization.render('phenotips.tableMacros.newEntry')&lt;/a>&lt;/span>{{/html}}#if ($services.localization.get("$!{classname}_hint")) {{icon name="question-circle" cssClass="xHelpButton" title="$services.localization.render("${classname}_hint").replace('"', '~~~"')"/}}#end&#xd;
#end&#xd;
&#xd;
#macro (__extradata_displayTable $dataClassName $options)&#xd;
  #if (!$options.mode)&#xd;
    #set ($discard = $options.put('mode', $xcontext.action))&#xd;
  #end&#xd;
  #set($dataClass = $xwiki.getDocument($dataClassName).xWikiClass)&#xd;
  #if ($dataClass)&#xd;
    #set($dataObjects = $doc.getObjects($dataClassName, "$!{options.propertyName}", "$!{options.propertyValue}"))&#xd;
    #if ($options.mode != 'edit' &amp;&amp; $dataObjects.size() == 0)&#xd;
      (% class="hint" %)$services.localization.render('phenotips.tableMacros.noObjects')&#xd;
    #elseif ($options.mode == 'export')&#xd;
      (% class="extradata-list#if ("$!{options.labels}" == 'true') withLabel#end#if ("$!{options.counter}" == 'true') withCounter#end" id="extradata-list-${dataClassName}#if("$!{options.propertyName}" != '')-$!{options.propertyValue}#end" %)&#xd;
      #set ($disableLabels = true)&#xd;
      #foreach ($o in $dataObjects)&#xd;
        #foreach($prop in $dataClass.properties)#if ($prop.name != $options.propertyName)|= ${prop.translatedPrettyName}: |#if ($velocityCount &lt;= 2)=#end $doc.display($prop.getName(), $options.mode, $o)#if ($velocityCount %2 == 0)&#xd;
&#xd;
        #end#end#end## foreach object&#xd;
&#xd;
      #end## foreach object&#xd;
    #else&#xd;
      (% class="extradata-list#if ("$!{options.labels}" == 'true') withLabel#end#if ("$!{options.counter}" == 'true') withCounter#end $!{options.cssClass}" id="extradata-list-${dataClassName}#if("$!{options.propertyName}" != '')-$!{options.propertyValue}#end" %)&#xd;
      #if ("$!{options.counter}" == 'true')|=(% class="col-label" %)# #end#foreach($prop in $dataClass.properties)|=(% class="col-label $prop.name#if ($prop.name == $options.propertyName) hidden#end" %)$prop.translatedPrettyName#end#if ($options.mode == 'edit')|=(% class="actions" %)&#xd;
      #else&#xd;
&#xd;
      #end&#xd;
      #if ($options.mode == 'export')#set ($disableLabels = true)#end&#xd;
      #foreach ($o in $dataObjects)&#xd;
        #if ("$!{options.counter}" == 'true')|=(% class="row-count" %)${velocityCount}#end#foreach($prop in $dataClass.properties)|(% class="$prop.name#if ($prop.name == $options.propertyName) hidden#end" %)#if ("$!{options.labels}$!{disableLabels}" == 'true'){{html clean="false" wiki="false"}}&lt;label class="" >${prop.translatedPrettyName}&lt;/label>{{/html}}#end $doc.display($prop.getName(), $options.mode, $o).replaceAll('^(\{\{html clean="false" wiki="false"}})?&lt;p>|&lt;/p>(\{\{/html}})?$', '$1$2')#end#if ($options.mode == 'edit')|(% class="actions" %)#__extradata_deleteTool($o "extradata-${dataClassName}")#end&#xd;
&#xd;
      #end## foreach object&#xd;
&#xd;
      #if ($options.mode == 'edit')(% class="list-actions" %)(((#__extradata_addTool($dataClassName "extradata-${dataClassName}" $options))))&#xd;
      #end&#xd;
    #end## if options.mode&#xd;
  #end## if dataclass&#xd;
#end&#xd;
&#xd;
#macro (__extradata_displayLastEntry $dataClassName $options)&#xd;
  #set ($objects = $doc.getObjects($dataClassName))&#xd;
  #if ($objects.size() > 0)&#xd;
    #set ($targetObj = $objects.get($mathtool.sub($objects.size(), 1)))&#xd;
    #set($dataClass = $targetObj.xWikiClass)&#xd;
    {{html wiki="true" clean="false"}}#foreach($prop in $dataClass.properties)&lt;td class="${prop.name}#if ($prop.name == $options.propertyName) hidden#end">#if ("$!{options.labels}" == 'true'){{html clean="false" wiki="false"}}&lt;label>${prop.translatedPrettyName}:&lt;/label>{{/html}}#end$doc.display($prop.getName(), $options.mode, $targetObj)&lt;/td>#end#if ($options.mode == 'edit')&lt;td class="actions">#__extradata_deleteTool($targetObj '')&lt;/td>#end{{/html}}&#xd;
  #end&#xd;
#end&#xd;
{{/velocity}}</content>
  <object>
    <name>PhenoTips.TabelarDataMacros</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>bc8be6ae-af69-4ca1-a439-ec5087bd156d</guid>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>var ExtraData = (function (ExtraData) {&#xd;
  var tools = ExtraData.tools = ExtraData.tools || {};&#xd;
  tools.Editor = Class.create({&#xd;
    initialize : function () {&#xd;
      $$('.extradata-list a.delete').invoke('observe', 'click', this.ajaxDeleteData.bindAsEventListener(this));&#xd;
      $$('.list-actions a.add').invoke('observe', 'click', this.ajaxAddData.bindAsEventListener(this));&#xd;
    },&#xd;
    ajaxDeleteData : function (event) {&#xd;
      event.stop();&#xd;
      var deleteTrigger = event.element();&#xd;
      if (deleteTrigger.disabled) {&#xd;
         return;&#xd;
      }&#xd;
      new XWiki.widgets.ConfirmedAjaxRequest(deleteTrigger.href, {&#xd;
        onCreate : function() {&#xd;
          deleteTrigger.disabled = true&#xd;
        },&#xd;
        onSuccess : function() {&#xd;
          var dataRow = deleteTrigger.up('tr:not(.head-group)');&#xd;
          var dataTable = deleteTrigger.up('table.extradata-list');&#xd;
          if (dataRow) {&#xd;
            dataRow.remove();&#xd;
            Event.fire(dataTable, 'extradata:deleted', {'element' : dataRow});&#xd;
          }&#xd;
          if (dataTable) {&#xd;
            var i = 1;&#xd;
            dataTable.select('th.row-count').each(function(item) {&#xd;
              item.update((i++));&#xd;
            });&#xd;
            Event.fire(document, 'xwiki:dom:updated', {'elements' : [dataTable]});&#xd;
          }&#xd;
        },&#xd;
        onComplete : function() {&#xd;
          deleteTrigger.disabled = false;&#xd;
        }&#xd;
      },&#xd;
      {&#xd;
         confirmationText : "$services.localization.render('phenotips.tableMacros.rowDeleteConfirmation')"&#xd;
      });&#xd;
    },&#xd;
    ajaxAddData : function (event) {&#xd;
      event.stop();&#xd;
      var addTrigger = event.element();&#xd;
      if (addTrigger.disabled) {&#xd;
         return;&#xd;
      }&#xd;
      var classname = '';&#xd;
      try {&#xd;
        var classname = /classname=([^&amp;]+)/.exec(addTrigger.href)[1];&#xd;
      } catch (err) {&#xd;
         new XWiki.widgets.Notification('Cannot add data: type not found', 'error');&#xd;
         return;&#xd;
      }&#xd;
      var dataTable = addTrigger.up('.list-actions').previous('table[id^="extradata-list-' + classname + '"]');&#xd;
      if (!dataTable) {&#xd;
        new XWiki.widgets.Notification("$services.localization.render('phenotips.tableMacros.listNotFound')" + ' ' + classname, 'error');&#xd;
      }&#xd;
      var propertyName = addTrigger.href.replace(/.*&amp;xredirect=.*propertyName=([^&amp;]*).*/, '$1') || '';&#xd;
      var propertyValue = addTrigger.href.replace(/.*&amp;xredirect=.*propertyValue=([^&amp;]*).*/, '$1') || '';&#xd;
      var addedDisplaySheet = addTrigger.href.replace(/.*&amp;xredirect=.*addedDisplaySheet=([^&amp;]*).*/, '$1') || '';&#xd;
      var url = addTrigger.href.replace(/(&amp;xredirect=[^&amp;]*)/m, '$1' + encodeURIComponent('?xpage=plain&amp;xaction=lastentry&amp;dataClassName=' + classname + '&amp;withLabel=' + dataTable.hasClassName('withLabel') + '&amp;propertyName=' + propertyName + '&amp;propertyValue=' + propertyValue + (addedDisplaySheet ? '&amp;sheet=' + addedDisplaySheet : ''))).replace(/#.*/m, '');&#xd;
      new Ajax.Request(url, {&#xd;
        onCreate : function() {&#xd;
          addTrigger.disabled = true&#xd;
          addTrigger._x_notif = new XWiki.widgets.Notification('Adding...', 'inprogress');&#xd;
        },&#xd;
        onSuccess : function (response) {&#xd;
          addTrigger._x_notif.hide();&#xd;
          var newRow = new Element('tr', {'class' : 'new'});&#xd;
          dataTable.down('tbody').insert(newRow);&#xd;
          if (dataTable.hasClassName('withCounter')) {&#xd;
            var idx = dataTable.select('.row-count').size() + 1;&#xd;
            newRow.insert(new Element('th', {'class' : 'row-count'}).update(idx));&#xd;
          }&#xd;
          newRow.insert(response.responseText);&#xd;
          newRow.down('a.delete').observe('click', this.ajaxDeleteData.bindAsEventListener(this));&#xd;
          Event.fire(dataTable, 'extradata:added', {'element' : newRow});&#xd;
          Event.fire(document, 'xwiki:dom:updated', {'elements' : [newRow]});&#xd;
        }.bind(this),&#xd;
        onFailure : function(response) {&#xd;
          var failureReason = response.statusText;&#xd;
          if (response.statusText == '' /* No response */ || response.status == 12031 /* In IE */) {&#xd;
            failureReason = 'Server not responding';&#xd;
          }&#xd;
          if (addTrigger._x_notif) {&#xd;
            addTrigger._x_notif.replace(new XWiki.widgets.Notification("Failed: " + failureReason, "error"));&#xd;
          } else {&#xd;
            new XWiki.widgets.Notification(this.interactionParameters.failureMessageText + failureReason, "error");&#xd;
          }&#xd;
        },&#xd;
        on1223 : function(response) {&#xd;
          response.request.options.onSuccess(response);&#xd;
        },&#xd;
        on0 : function(response) {&#xd;
          response.request.options.onFailure(response);&#xd;
        },&#xd;
        onComplete : function() {&#xd;
          addTrigger.disabled = false&#xd;
        }&#xd;
      });&#xd;
    }&#xd;
  });&#xd;
  return ExtraData;&#xd;
}(ExtraData || {}));&#xd;
&#xd;
document.observe('xwiki:dom:loaded', function() {&#xd;
  new ExtraData.tools.Editor();&#xd;
})</code>
    </property>
    <property>
      <name></name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.TabelarDataMacros</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>ae82f359-cbf6-4b2d-a634-e0ca99f22ae8</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>#template('colorThemeInit.vm')&#xd;
table.extradata-list {&#xd;
    width: 100%;&#xd;
    vertical-align: top;&#xd;
}&#xd;
.extradata-list td, .extradata-list th {&#xd;
    border: 1px solid $theme.backgroundSecondaryColor;&#xd;
    border-left: 1px solid $theme.pageContentBackgroundColor;&#xd;
    border-right: 1px solid $theme.pageContentBackgroundColor;&#xd;
}&#xd;
.extradata-list th.col-label {&#xd;
    text-align: left;&#xd;
    font-weight: normal;&#xd;
    font-variant: small-caps;&#xd;
}&#xd;
.extradata th.col-label, .viewbody td {&#xd;
    text-align: center;&#xd;
}&#xd;
.viewbody td.comments, .editbody th.comments {&#xd;
    border-right: 0 none;&#xd;
}&#xd;
.extradata-list th.row-count {&#xd;
    background: transparent;&#xd;
}&#xd;
.extradata-list th.row-count,&#xd;
.extradata-list td.start,&#xd;
.extradata-list td.end {&#xd;
    text-align: left;&#xd;
}&#xd;
.extradata-list td.start,&#xd;
.extradata-list td.end,&#xd;
.extradata-list td.band {&#xd;
    min-width: 6em;&#xd;
}&#xd;
.extradata-list th.comments {&#xd;
    min-width: 20em;&#xd;
}&#xd;
.extradata-list .xwiki-form-listclass {&#xd;
    display: block;&#xd;
    white-space: nowrap;&#xd;
}&#xd;
.extradata-list th.actions {&#xd;
  width: 24px;&#xd;
}&#xd;
.extradata-list th.actions .buttonwrapper {&#xd;
    display: block;&#xd;
    height: 2.3em;&#xd;
    position: relative;&#xd;
    margin: 0;&#xd;
}&#xd;
.extradata-list th.actions a.delete {&#xd;
  background-image: url("$xwiki.getSkinFile('icons/silk/cross.png')");&#xd;
}&#xd;
.extradata-list th.actions .add-data-button {&#xd;
    position: absolute;&#xd;
    right: 0;&#xd;
}&#xd;
.list-actions {&#xd;
  position: relative;&#xd;
  width: 50%;&#xd;
}&#xd;
.list-actions .buttonwrapper {&#xd;
  text-align: left;&#xd;
  margin: 0 !important;&#xd;
}&#xd;
table.withLabel td, table.withLabel th {&#xd;
  border: 0 none;&#xd;
}&#xd;
table.withLabel tr:first-child th {&#xd;
  display: none;&#xd;
}&#xd;
.extradata-list .file {&#xd;
  width: 160px;&#xd;
  max-width: 160px;&#xd;
}&#xd;
.extradata-list .file .attachment-list .attachment-item, .extradata-list .file .attachment-list .attachment-item input {&#xd;
  display: none;&#xd;
}&#xd;
.extradata-list .file .attachment-list .attachment-item.selected {&#xd;
  display: block;&#xd;
  width: 100%;&#xd;
}&#xd;
.extradata-list .file .attachment-list .attachment-item.image {&#xd;
  width: 150px !important;&#xd;
}&#xd;
.extradata-list .file .attachment-list .attachment-item.selected label {&#xd;
  padding: 3px 0 3px 20px;&#xd;
}&#xd;
.extradata-list .file .attachment-list .attachment-item.image label {&#xd;
  padding: 0 !important;&#xd;
}&#xd;
.extradata-list .file .attachment-list .attachment-item .attachment-preview {&#xd;
    width: 140px;&#xd;
}&#xd;
.extradata-list .file p img {&#xd;
  max-width: 480px !important;&#xd;
  max-height: 480px !important;&#xd;
}&#xd;
.extradata-list .file .attachment-list .attachment-item .view {&#xd;
  background-color: $theme.pageContentBackgroundColor;&#xd;
  bottom: 0;&#xd;
  padding: 5px;&#xd;
}</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name></name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
</xwikidoc>
