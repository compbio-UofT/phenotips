<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>DefaultPermissionsMacros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1401822205000</creationDate>
  <parent>PhenoTips.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1401822205000</date>
  <contentUpdateDate>1401822205000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity}}
#set($configClassName = 'XWiki.ConfigurationClass')
##
#macro(__displayVisibility $visibilityPref)
#if ($visibilityPref &amp;&amp; "$!{visibilityPref}" != '')
  #foreach ($l in $services.permissions.listVisibilityOptions())
    #if("${l.name}" == "$!visibilityPref")
      &lt;div class="access-rights-info visibility" title="$!{l.description}"&gt;{{icon name="${l.name}" /}}${l.name}&lt;/div&gt;
    #end
  #end
#end
#end
##
#macro(__displayCollabAccessLevel $accessLevel)
#if ($accessLevel &amp;&amp; "$!{accessLevel}" != '')
  #foreach ($l in $services.permissions.listAccessLevels())
    #if("${l.name}" == "$!accessLevel")
      &lt;div class="access-level-info" title="$!{l.description}"&gt;{{icon name="${l.name}" /}}${l.name}&lt;/div&gt;
    #end
  #end
#end
#end
##
#macro(__displayEntity $ref)
#if ($ref &amp;&amp; "$!{ref}" != '')
  #set($docRef = $services.model.resolveDocument($ref))
  #set($edoc = $xwiki.getDocument($docRef))
  ## A document can represent both a user and a group.
  ## Is it a user?
  #if ($edoc.getObject('XWiki.XWikiUsers'))
    #set($name = $xwiki.getUserName($edoc.fullName, false))
    #set($iconClass = "fa fa-user")
  #else
    #set($name = $edoc.getName())
    #set($iconClass = "fa fa-group")
  #end
  &lt;div class="user-avatar-wrapper"&gt;
    &lt;a href="$xwiki.getURL($ref)"&gt;
      &lt;span class="$iconClass"&gt; &lt;/span&gt;$name
    &lt;/a&gt;
  &lt;/div&gt;
#end
#end
##
##
## generate existing default collaborator JSON string to generate UI on load
##
#macro(__setCollabJSON $o $value)
  #set ($prefix = "${configClassName}_${o.number}_value")
  #set ($collabValue = "$!{o.getProperty('value').value}")
  #set ($collabArray = $collabValue.split('\^'))
  #set ($id = $collabArray[0])
  #if($collabArray.size() &gt; 1)
    #set ($access = $collabArray[1])
  #else
    #set ($access = 'view')
  #end
  #set ($docRef = $services.model.resolveDocument($id))
  #set ($edoc = $xwiki.getDocument($docRef))
  #if ($edoc.getObject('XWiki.XWikiUsers'))
    #set ($type = 'user')
    #set ($name = "$!{xwiki.getUserName($edoc.fullName, false)}")
  #else
    #set ($type = 'group')
    #set ($name = "$!{edoc.getName()}")
  #end
  #if(!$edoc.attachmentList.isEmpty())
    #set ($icon = $!{edoc.getAttachmentURL($edoc.attachmentList[0].filename,"download")})
  #else
    #set ($icon = "$xwiki.getSkinFile('icons/xwiki/noavatar.png')")
  #end
  #set ($value = "{'id' : '$id', 'name' : '$name', 'access' : '$access', 'for' : '$prefix', 'type' : '$type'#if($icon != ''), 'icon' : '$icon'#end}")
#end
##
##
#macro(__displayPreferencesSelectList $defaultWorkgroupObject $defaultWorkgroupPreference)
  #if ($xcontext.action == 'edit' &amp;&amp; $hasEdit)
    #if (!$defaultWorkgroupObject)
      #set ($defaultWorkgroupObject = $doc.newObject($configClassName))
      #set ($discard = $defaultWorkgroupObject.set('property', 'defaultWorkgroup'))
      #set ($discard = $defaultWorkgroupObject.set('value', ''))
      #set ($discard = $doc.save('Added a workgroup reference configuration', true))
    #end
    #set ($prefix = "${configClassName}_${defaultWorkgroupObject.number}_value")
    &lt;label class="group-settings" for="${prefix}_$group.reference"&gt;
      &lt;input type="radio" name="${prefix}" value="" #if($defaultWorkgroupPreference == '') checked="checked"#end /&gt;
        $services.localization.render('platform.core.profile.category.dataEntry.myPreferences')
    &lt;/label&gt;
    #set ($userGroups = $services.groups.getGroupsForUser($services.users.getCurrentUser()))
    #if ($userGroups.size() &gt; 0)
      #foreach ($group in $userGroups)
        &lt;label class="group-settings" for="${prefix}_$group.reference"&gt;
          &lt;input type="radio" name="${prefix}" #if($group.reference == $defaultWorkgroupPreference)checked="checked"#end value="$group.reference" /&gt;
            &lt;span class="fa fa-group"&gt; &lt;/span&gt;
            &lt;a href="$xwiki.getURL($group.reference)"&gt;$group.getReference().getName()&lt;/a&gt;
        &lt;/label&gt;
      #end
    #end
  #else
    #if ($defaultWorkgroupObject)
      #if ("$!{defaultWorkgroupPreference}" != '')
        #__displayEntity($defaultWorkgroupPreference)
      #end
    #end
  #end
#end
##
##
#macro(__displayDefaultOwnerPreference $entityType $prefSourceDoc $viewOnly)
  #set ($defaultOwnerObject = $prefSourceDoc.getObject($configClassName, 'property', 'defaultOwner', false))
  #if (!$defaultOwnerObject &amp;&amp; !$viewOnly)
    #set ($defaultOwnerObject = $prefSourceDoc.newObject($configClassName))
    #set ($discard = $defaultOwnerObject.set('property', 'defaultOwner'))
    #if ($entityType == 'user')
      #set ($defaultOwnerPreference = $prefSourceDoc.prefixedFullName)
    #else
      #set ($defaultOwnerPreference = '')
    #end
    #set ($discard = $defaultOwnerObject.set('value', $defaultOwnerPreference))
    #set ($discard = $prefSourceDoc.save('Added a default owner preference configuration', true))
  #else
    #set ($defaultOwnerPreference = $defaultOwnerObject.getProperty('value').value)
  #end
  #if ($xcontext.action == 'edit' &amp;&amp; $hasEdit  &amp;&amp; !$viewOnly)
    #if ("$!{defaultOwnerPreference}" != '')
      #set ($defaultOwnerName = $services.model.resolveDocument($defaultOwnerPreference).getName())
    #else
      #set ($defaultOwnerName = '')
    #end
    #set ($c = 'platform.core.profile.category.dataEntry.' + ${entityType} + '.ownerText')
    $services.localization.render($c)
    #set ($prefix = "${configClassName}_${defaultOwnerObject.number}_value")
    &lt;input type="text" name="${prefix}" class="suggestUsersAndGroups" value="$defaultOwnerName"/&gt;
  #else
    #__displayEntity($defaultOwnerPreference)
  #end
#end
##
##
##
#macro(__displayDefaultVisibilityPreference $entityType $prefSourceDoc $viewOnly)
  #set ($defaultVisibilityObject = $prefSourceDoc.getObject($configClassName, 'property', 'defaultVisibility', false))
  #if (!$defaultVisibilityObject &amp;&amp; !$viewOnly)
    #set ($defaultVisibilityObject = $prefSourceDoc.newObject($configClassName))
    #set ($discard = $defaultVisibilityObject.set('property', 'defaultVisibility'))
    #set ($discard = $defaultVisibilityObject.set('value', 'private'))
    #set ($discard = $prefSourceDoc.save('Added a default private visibility preference configuration', true))
    #set ($defaultVisibilityPreference = 'private')
  #else
    #set ($defaultVisibilityPreference = $defaultVisibilityObject.getProperty('value').value)
  #end
  #if($xcontext.action == 'edit' &amp;&amp; $hasEdit &amp;&amp; !$viewOnly)
    #set ($c = 'platform.core.profile.category.dataEntry.' + ${entityType} + '.visibilityText')
    $services.localization.render($c)
    #set ($prefix = "${configClassName}_${defaultVisibilityObject.number}_value")
    &lt;table id="access-levels-table"&gt;
    #foreach ($option in $services.permissions.listVisibilityOptions())
      &lt;tr&gt;
        &lt;td&gt;{{icon name="${option.name}" /}}&lt;/td&gt;
        &lt;td&gt;
          &lt;label class="visibility" for="${prefix}_${option.name}"&gt;
            &lt;input type="radio" name="${prefix}" value="${option.name}" id="${prefix}_${option.name}"#if ($option == $defaultVisibilityPreference) checked="checked"#end alt="$!{option.label}" title="$!{option.description}" /&gt;
              $services.localization.render("phenotips.permissions.visibility.${option.name}.label")
          &lt;/label&gt;
        &lt;/td&gt;
        &lt;td&gt;
          &lt;p class="intro xHint"&gt;$!{option.description}&lt;/p&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    #end
    &lt;/table&gt;
  #else
    #__displayVisibility($defaultVisibilityPreference)
  #end
#end
##
##
##
#macro(__displayDefaultCollaboratorPreference $entityType $prefSourceDoc $viewOnly)
  #set ($defaultCollaboratorObjects = $prefSourceDoc.getObjects($configClassName, 'property', 'defaultCollaborator'))
  #if ($xcontext.action == 'edit' &amp;&amp; $hasEdit &amp;&amp; !$viewOnly)
    #set ($c = 'platform.core.profile.category.dataEntry.' + ${entityType} + '.collaboratorsText')
    $services.localization.render($c)
    ## List all defaultCollaborators as hidden inputs to generate selected suggestions in edit mode
    #if ($defaultCollaboratorObjects &amp;&amp; !$defaultCollaboratorObjects.isEmpty())
      #foreach ($o in $defaultCollaboratorObjects)
        ## generate value as JSON string
        #set ($value = "")
        #__setCollabJSON($o $value)
        &lt;input type="hidden" class="default-collaborator" value="$value" /&gt;
      #end
    #end
    ##
    ## List all access levels as hidden inputs
    #foreach ($l in $services.permissions.listAccessLevels())
      &lt;input type="hidden" name="access-level" value="${l.name}" alt="$!{l.description}" /&gt;
    #end
    ##
    ## Save service URL with tocken
    &lt;input type="hidden" id="service-url" value="$xwiki.getDocument('PhenoTips.UserProfileService').getURL('get', "config_classname=${configClassName}&amp;collab_namepropname=property&amp;collab_namepropvalue=defaultCollaborator&amp;form_token=$!{services.csrf.getToken()}&amp;page=$prefSourceDoc.fullName&amp;outputSyntax=plain")" /&gt;
    ##
    &lt;div id="manage-collaborators"&gt;&lt;input id="collaborators-suggest-input" type="text" name="${configClassName}_NUMBER_value" class="suggestUsersAndGroups" value=""/&gt;&lt;/div&gt;
  #else
    #if ($defaultCollaboratorObjects &amp;&amp; !$defaultCollaboratorObjects.isEmpty())
      #foreach ($c in $defaultCollaboratorObjects)
        #set ($defaultCollaboratorPreference = $c.getProperty('value').value)
        #if ("$!{defaultCollaboratorPreference}" != '')
          #set ($collabSetting = $defaultCollaboratorPreference.split('\^'))
          &lt;div&gt;
            #__displayEntity($collabSetting[0])
            #if ($collabSetting.size() &gt; 1)
              #__displayCollabAccessLevel($collabSetting[1])
            #else
              #__displayCollabAccessLevel('view')
            #end
          &lt;/div&gt;
        #end
      #end
    #end
  #end
#end
##
##
##
#macro(__displayUserOrGroupPreferences $entityType $defaultWorkgroupPreference $prefSourceDoc $viewOnly)
#if ($xcontext.action == 'edit')
  #set ($hidden = true)
  #if ("$!{defaultWorkgroupPreference}" != '' &amp;&amp; $prefSourceDoc.prefixedFullName == $defaultWorkgroupPreference || "$!{defaultWorkgroupPreference}" == '' &amp;&amp; $prefSourceDoc.prefixedFullName == $doc.prefixedFullName)
    #set ($hidden = false)
  #end
&lt;div class="preferences half column xform #if($hidden)hidden#end" id="$prefSourceDoc.prefixedFullName"&gt;
  &lt;div class="dataEntry"&gt;
    &lt;dl&gt;
#end
      &lt;dt&gt;
        &lt;h2&gt;$services.localization.render('platform.core.profile.category.dataEntry.defaultPermissions')&lt;/h2&gt;
      &lt;/dt&gt;
###### Owner preferences
      &lt;dt class="label"&gt;
        &lt;label&gt;$services.localization.render('platform.core.profile.category.dataEntry.owner')&lt;/label&gt;
        &lt;p class="intro xHint"&gt;$services.localization.render('phenotips.accessRightsManagement.modifyOwnershipBody')&lt;/p&gt;
      &lt;/dt&gt;
      &lt;dd&gt;
        #__displayDefaultOwnerPreference($entityType $prefSourceDoc $viewOnly)
      &lt;/dd&gt;
###### Visibility preferences
      &lt;dt class="label"&gt;
        &lt;label&gt;$services.localization.render('platform.core.profile.category.dataEntry.visibility')&lt;/label&gt;
        &lt;p class="intro xHint"&gt;$services.localization.render('phenotips.accessRightsManagement.modifyVisibilityBody')&lt;/p&gt;
      &lt;/dt&gt;
      &lt;dd&gt;
        #__displayDefaultVisibilityPreference($entityType $prefSourceDoc $viewOnly)
      &lt;/dd&gt;
###### Collaborators preferences
      &lt;dt class="label"&gt;
        &lt;label&gt;$services.localization.render('platform.core.profile.category.dataEntry.collaborators')&lt;/label&gt;
        &lt;p class="intro xHint"&gt;$services.localization.render('phenotips.accessRightsManagement.modifyCollaboratorsBody')&lt;/p&gt;
      &lt;/dt&gt;
      &lt;dd&gt;
        #__displayDefaultCollaboratorPreference($entityType $prefSourceDoc $viewOnly)
      &lt;/dd&gt;
###### STUDY
      &lt;dt&gt;
        &lt;h2&gt;$services.localization.render('platform.core.profile.category.dataEntry.study')&lt;/h2&gt;
      &lt;/dt&gt;
      &lt;dd&gt;
        #__displayDefaultStudyPreference($entityType $prefSourceDoc $viewOnly)
      &lt;/dd&gt;
    &lt;/dl&gt;
  &lt;/div&gt;
&lt;/div&gt;
#end
{{/velocity}}
</content>
</xwikidoc>
