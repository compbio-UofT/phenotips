<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.2" reference="PhenoTips.DiseasePredictService2" locale="">
  <web>PhenoTips</web>
  <name>DiseasePredictService2</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1567694488000</creationDate>
  <parent>PhenoTips.WebHome</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1567694488000</date>
  <contentUpdateDate>1567694488000</contentUpdateDate>
  <version>1.1</version>
  <title/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>false</hidden>
  <content>{{velocity filter="indent"}}
#if ($xcontext.action != 'get')
  $response.sendRedirect($doc.getURL('get', "$!{request.queryString}"))
#end
$response.setHeader("X-ReqNo", "$!request.reqNo")##
#set ($limit = $mathtool.toInteger("$!{request.limit}"))
#if (!$limit || $limit &lt; 0)
  #set ($limit = 20)
#end
#set ($symptoms = [])
#set ($freeSymptoms = [])
#foreach ($piece in $!request.getParameterValues('symptom'))
  #set($discard = $symptoms.add($piece))
#end
#foreach ($piece in $!request.getParameterValues('free_symptom'))
  #set($discard = $freeSymptoms.add($piece))
#end
#if ("$!{request.format}" == 'html')
  #set ($results = $services.diagnosis.get($symptoms, $freeSymptoms, $limit))
  #if ($results.size() &gt; 0)
    {{html clean="false" wiki="false"}}##
    &lt;ul class="vocabulary-term-list"&gt;
    #foreach($term in $results)
      #set ($name = $term.getName())
      #set ($id = $term.getId())
      #if ($term.id.indexOf(':') &gt;= 0)
        #set ($unprefixedId = $stringtool.substringAfter($term.id, ':'))
      #else
        #set ($unprefixedId = $term.id)
      #end
      #set ($fullName = $name)
      #if ($term.short_name &amp;&amp; $term.short_name.size() &gt; 0)
        #set ($fullName = $fullName.concat('; ').concat($stringtool.join($term.short_name, ', ')))
      #end
      &lt;li class="disorder"&gt;
        &lt;span class="term-id" title="${id}"&gt;&lt;a href="http://www.omim.org/entry/${unprefixedId}" target="_blank" title="${services.localization.render('phenotips.UIXField.diagnosisSuggestions.omimSearch.result.title')}"&gt;${stringtool.defaultString($!term.symbol, ' ')}${unprefixedId}&lt;/a&gt;&lt;/span&gt;
        &lt;span class="term-name" title="${fullName}"&gt;${name}&lt;/span&gt;
      &lt;/li&gt;
    #end ## foreach item
    &lt;/ul&gt;
    {{/html}}
  #else
    (% class="hint" %)No matches found
  #end## results.size() &gt; 0
#elseif ("$!{request.format}" == 'json')
  $response.setContentType('application/json')
  #set ($results = $services.diagnosis.get($symptoms, $freeSymptoms, $limit))
  #set ($resultsJson = [])
  #foreach($term in $results)
    #set ($discard = $resultsJson.add({'id' : $term.getId(), 'name': $term.getName(), 'url' : "http://www.omim.org/entry/${term.getId()}", 'score': $term.score}))
  #end## foreach item
  #if ("$!{request.outputSyntax}" == 'plain')
    {{content syntax="plain/1.0"}}$jsontool.serialize($resultsJson){{/content}}
  #else
    {{html wiki="false" clean="false"}}$jsontool.serialize($resultsJson){{/html}}
  #end
  #set ($hasOutput = true)
#end## format
{{/velocity}}</content>
</xwikidoc>
